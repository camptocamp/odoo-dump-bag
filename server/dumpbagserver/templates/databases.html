{% extends "layout.html" %}
{% set active_page = "databases" %}
{% block body %}

<div class="databases">

  <div class="progress" style="display: none;">
    <div id="progress-bar"
      class="mdl-progress mdl-js-progress mdl-progress__indeterminate bar">
    </div>
    <div class="progress-caption"></div>
  </div>

  <ul class="mdl-list database-list">
    {% for dbname in databases | sort %}
    <li class="mdl-list__item">
      <span class="mdl-list__item-primary-content">
        <a
          title="Push dump to storage"
          class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect"
          onclick="askNewDump('{{dbname}}')"
          >
          Create dump for {{dbname}} and push it!
        </a>
      </span>
    </li>
    {% endfor %}
  </ul>

  <dialog class="mdl-dialog">
    <h4 class="mdl-dialog__title">Really create a new dump?</h4>
    <div class="mdl-dialog__content">
      <p>
      There is already a dump for this database for today,
      unless this is really needed, use the existing one. Thanks!
      </p>
    </div>
    <div class="mdl-dialog__actions">
      <button type="button" class="mdl-button confirm">I'm sure I need a new dump</button>
      <button type="button" class="mdl-button close">Got it, close.</button>
    </div>
  </dialog>

  <script>
    var dialog;
    function askNewDump(dbname) {
      showProgressBar('Checking...');
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'has_dump_for_today/' + dbname);
      xhr.send(null);
      xhr.onreadystatechange = function () {
        var DONE = 4; // readyState 4 means the request is done.
        var OK = 200; // status 200 is a successful return.
        if (xhr.readyState === DONE) {
          if (xhr.status === OK) {
            var hasDump = JSON.parse(xhr.responseText);
            hideProgressBar();
            if (hasDump) {
              openDialog(dbname);
            } else {
              confirmNewDump(dbname);
            }
          } else {
            console.log('Error: ' + xhr.status); // An error occurred during the request.
          }
        }
      };
    }

    function showProgressBar(caption) {
      var progress = document.querySelector('.progress');
      progress.style.display = 'block';
      progress.querySelector('.progress-caption').innerHTML = caption;
    }

    function hideProgressBar() {
      var progress = document.querySelector('.progress');
      progress.style.display = 'none';
      progress.querySelector('.progress-caption').innerHTML = '';
    }

    function confirmNewDump(dbname) {
      showProgressBar('Dump in progress, please wait');
      document.location.href = 'dump/' + dbname;
    }

    function openDialog(dbname) {
      var confirm = dialog.querySelector('.confirm');
      // clean previous event listeners by replacing the element
      var newConfirm = confirm.cloneNode(true);
      confirm.parentNode.replaceChild(newConfirm, confirm);
      newConfirm.addEventListener('click', function() {
        dialog.close()
        confirmNewDump(dbname);
      });
      dialog.showModal();
    }

    function setupDialog(dbname) {
      var dialog = document.querySelector('dialog');
      var showDialogButton = document.querySelector('#show-dialog');
      if (! dialog.showModal) {
        dialogPolyfill.registerDialog(dialog);
      }
      dialog.querySelector('.close').addEventListener('click', function() {
        dialog.close();
      });
      return dialog;
    }
    dialog = setupDialog();
  </script>

</div>
{% endblock %}
